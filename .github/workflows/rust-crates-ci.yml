name: Rust Crates CI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      crate:
        description: 'Crate to publish'
        required: true
        type: choice
        options:
          - estimators
          - partition_tree

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  test-estimators:
    name: Test estimators crate
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.crate == 'estimators' || startsWith(github.ref, 'refs/tags/estimators-v') }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Rust stable
        run: |
          rustup update stable
          rustup default stable
          rustc -V
          cargo -V

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crates/estimators/target
          key: ${{ runner.os }}-cargo-estimators-${{ hashFiles('crates/estimators/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-estimators-

      - name: Build estimators
        working-directory: crates/estimators
        run: cargo build --release

      - name: Test estimators
        working-directory: crates/estimators
        run: cargo test --release

  test-partition-tree:
    name: Test partition_tree crate
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.crate == 'partition_tree' || startsWith(github.ref, 'refs/tags/partition_tree-v') }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Rust stable
        run: |
          rustup update stable
          rustup default stable
          rustc -V
          cargo -V

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crates/partition_tree/target
          key: ${{ runner.os }}-cargo-partition-tree-${{ hashFiles('crates/partition_tree/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-partition-tree-

      - name: Build partition_tree
        working-directory: crates/partition_tree
        run: cargo build --release

      - name: Test partition_tree
        working-directory: crates/partition_tree
        run: cargo test --release

  publish-estimators:
    name: Publish estimators to crates.io
    runs-on: ubuntu-latest
    needs: [test-estimators]
    if: ${{ startsWith(github.ref, 'refs/tags/estimators-v') }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Rust stable
        run: |
          rustup update stable
          rustup default stable

      - name: Publish estimators
        working-directory: crates/estimators
        run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }}

  publish-partition-tree:
    name: Publish partition_tree to crates.io
    runs-on: ubuntu-latest
    needs: [test-partition-tree]
    if: ${{ startsWith(github.ref, 'refs/tags/partition_tree-v') }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Rust stable
        run: |
          rustup update stable
          rustup default stable

      - name: Publish partition_tree
        working-directory: crates/partition_tree
        run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }}
